<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ระบบจองแพทย์ออนไลน์</title>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Kanit',sans-serif}

body{
  min-height:100vh;
  background:linear-gradient(135deg,#7fb3ff,#cfe6ff);
  display:flex;
  justify-content:center;
  align-items:center;
  padding:40px;
}

.container{
  width:100%;
  max-width:1100px;
  background:rgba(255,255,255,0.7);
  backdrop-filter:blur(20px);
  border-radius:28px;
  padding:40px;
  box-shadow:0 20px 60px rgba(0,0,0,0.08);
}

.header{
  margin-bottom:30px;
}

.header h1{
  font-size:34px;
  font-weight:600;
  color:#1c3d5a;
}

.header p{
  color:#5c7a94;
}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:30px;
}

.card{
  background:white;
  border-radius:20px;
  padding:24px;
  box-shadow:0 10px 30px rgba(0,0,0,0.05);
}

.card h3{
  margin-bottom:16px;
  color:#1c3d5a;
}

.select, input{
  width:100%;
  padding:12px 14px;
  border-radius:12px;
  border:1px solid #e1edf5;
  margin-bottom:16px;
  font-size:15px;
}

.slots{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}

.slot{
  padding:10px 16px;
  border-radius:12px;
  border:1px solid #d6e7f5;
  cursor:pointer;
  transition:0.2s;
}

.slot:hover{
  background:#eaf6ff;
}

.slot.active{
  background:#2c8fff;
  color:white;
  border:none;
}

button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:14px;
  font-size:16px;
  background:#2c8fff;
  color:white;
  cursor:pointer;
  transition:0.25s;
}

button:hover{
  background:#1e6fd1;
}

.status{
  margin-top:16px;
  font-weight:500;
}

.success{color:#1aa85a}
.error{color:#e53935}

@media(max-width:900px){
  .grid{grid-template-columns:1fr}
}
</style>
</head>

<body>

<div class="container">

<div class="header">
<h1>ระบบจองแพทย์ออนไลน์</h1>
<p>เลือกแพทย์ วันที่ และเวลาที่ต้องการแบบ Real-time</p>
</div>

<div class="grid">

<!-- LEFT -->
<div class="card">

<h3>1. เลือกแพทย์</h3>
<select id="doctorSelect" class="select">
<option value="">กำลังโหลดรายชื่อแพทย์...</option>
</select>

<h3>2. เลือกวันที่</h3>
<input type="date" id="dateInput">

<h3>3. เลือกเวลาที่ว่าง</h3>
<div id="slots" class="slots"></div>

</div>

<!-- RIGHT -->
<div class="card">

<h3>4. ข้อมูลผู้ป่วย</h3>
<input id="patientName" placeholder="ชื่อ-นามสกุล">

<button onclick="bookAppointment()">ยืนยันการจอง</button>

<div id="status" class="status"></div>

</div>

</div>
</div>

<script>

const API_BASE = "http://localhost:5000"

let selectedDoctor = null
let selectedSlot = null

//------------------------------------------------
// LOAD DOCTORS
//------------------------------------------------
async function loadDoctors(){
  try{

    const res = await fetch(`${API_BASE}/api/doctors`)
    const doctors = await res.json()

    const select = document.getElementById("doctorSelect")
    select.innerHTML = '<option value="">-- เลือกแพทย์ --</option>'

    doctors.forEach(d=>{
      const opt = document.createElement("option")
      opt.value = d._id
      opt.textContent = `${d.name} (${d.specialization || ""})`
      select.appendChild(opt)
    })

  }catch(err){
    console.error(err)
    alert("โหลดรายชื่อแพทย์ไม่สำเร็จ")
  }
}

//------------------------------------------------
// DOCTOR SELECT
//------------------------------------------------
document.getElementById("doctorSelect").addEventListener("change", e=>{
  selectedDoctor = e.target.value
  selectedSlot = null
  loadSlots()
})

//------------------------------------------------
// DATE CHANGE
//------------------------------------------------
document.getElementById("dateInput").addEventListener("change", loadSlots)

//------------------------------------------------
// LOAD AVAILABLE SLOTS
//------------------------------------------------
async function loadSlots(){

  const date = document.getElementById("dateInput").value
  if(!selectedDoctor || !date) return

  try{

    const res = await fetch(
      `${API_BASE}/api/appointments/available-slots?doctor=${selectedDoctor}&date=${date}`
    )

    const data = await res.json()

    const container = document.getElementById("slots")
    container.innerHTML = ""

    if(!data.availableSlots || data.availableSlots.length===0){
      container.innerHTML = "ไม่มีเวลาว่าง"
      return
    }

    data.availableSlots.forEach(time=>{
      const div = document.createElement("div")
      div.className = "slot"
      div.textContent = time

      div.onclick = ()=>{
        document.querySelectorAll(".slot").forEach(s=>s.classList.remove("active"))
        div.classList.add("active")
        selectedSlot = time
      }

      container.appendChild(div)
    })

  }catch(err){
    console.error(err)
  }
}

//------------------------------------------------
// BOOK APPOINTMENT
//------------------------------------------------
async function bookAppointment(){

  const patientName = document.getElementById("patientName").value
  const date = document.getElementById("dateInput").value
  const status = document.getElementById("status")

  if(!selectedDoctor || !selectedSlot || !patientName || !date){
    status.innerHTML = '<span class="error">กรอกข้อมูลไม่ครบ</span>'
    return
  }

  try{

    const res = await fetch(`${API_BASE}/api/appointments`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        doctor: selectedDoctor,
        date: date,
        time: selectedSlot,
        patientName: patientName
      })
    })

    const data = await res.json()

    if(res.ok){
      status.innerHTML = '<span class="success">จองสำเร็จ</span>'
      loadSlots()
    }else{
      status.innerHTML = `<span class="error">${data.message}</span>`
    }

  }catch(err){
    status.innerHTML = '<span class="error">Server error</span>'
  }
}

//------------------------------------------------
// INIT
//------------------------------------------------
loadDoctors()

</script>

</body>
</html>