<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>การนัดของฉัน - Medica+</title>

<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:'Prompt',sans-serif;
}

body{
  background:linear-gradient(135deg,#7fb3ff,#cfe6ff);
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:40px;
}

.main-card{
  width:100%;
  max-width:1200px;
  background: rgba(255,255,255,0.55);
  backdrop-filter: blur(20px);
  border-radius:35px;
  padding:50px;
  box-shadow:0 25px 60px rgba(0,0,0,0.15);
}

.navbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:40px;
}

.logo{
  font-size:22px;
  font-weight:700;
  color:#123c70;
}

.nav-right{
  display:flex;
  gap:15px;
}

.nav-btn{
  padding:10px 25px;
  border-radius:25px;
  border:none;
  background: linear-gradient(135deg,#1f6feb,#3d8bfd);
  color:white;
  font-weight:600;
  cursor:pointer;
  box-shadow:0 8px 20px rgba(0,0,0,0.2);
  transition:0.3s;
}

.nav-btn:hover{
  transform:translateY(-3px);
}

.page-title{
  font-size:40px;
  font-weight:700;
  color:#0e2b50;
  margin-bottom:30px;
}

.section{
  margin-top:30px;
}

.section-title{
  font-weight:600;
  margin-bottom:15px;
  color:#1c3f75;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:20px;
}

.app-card{
  background:white;
  border-radius:25px;
  padding:25px;
  box-shadow:0 10px 30px rgba(0,0,0,0.08);
  position:relative;
  transition:0.3s;
}

.app-card:hover{
  transform:translateY(-6px);
}

.app-card h3{
  color:#0e2b50;
  margin-bottom:10px;
}

.app-card p{
  font-size:14px;
  margin:5px 0;
  color:#555;
}

/* ===== STATUS BADGE ===== */
.badge{
  position:absolute;
  top:20px;
  right:20px;
  padding:6px 14px;
  border-radius:20px;
  font-size:12px;
  font-weight:600;
  color:white;
}

.completed{ background:#22c55e; }   /* มาตามนัด */
.no-show{ background:#ef4444; }     /* ไม่มาตามนัด */
.cancelled{ background:#6b7280; }   /* ยกเลิก */

/* Cancel Button */
.cancel-btn{
  margin-top:15px;
  padding:8px 18px;
  border:none;
  border-radius:20px;
  background: linear-gradient(135deg,#ef4444,#dc2626);
  color:white;
  font-size:13px;
  font-weight:600;
  cursor:pointer;
  transition:0.3s;
}

.cancel-btn:hover{
  transform:scale(1.05);
  box-shadow:0 8px 20px rgba(0,0,0,0.2);
}
</style>
</head>

<body>

<div class="main-card">

  <div class="navbar">
    <div class="logo">Medica+</div>
    <div class="nav-right">
      <button class="nav-btn" onclick="location.href='index.html'">Home</button>
      <button class="nav-btn" onclick="location.href='index_old.html'">+ จองใหม่</button>
    </div>
  </div>

  <div class="page-title">การนัดของฉัน</div>

  <div class="section">
    <div class="section-title">การนัดที่กำลังจะมาถึง</div>
    <div class="grid" id="upcoming"></div>
  </div>

  <div class="section">
    <div class="section-title">การนัดที่ผ่านมา</div>
    <div class="grid" id="past"></div>
  </div>

</div>

<script>
async function loadAppointments(){
  const phone = localStorage.getItem("patientPhone");
  if(!phone) return;

  const res = await fetch(`https://medica-plus.onrender.com/api/appointments/my/${phone}`);
  const data = await res.json();

  const today = new Date();
  today.setHours(0,0,0,0);

  document.getElementById("upcoming").innerHTML="";
  document.getElementById("past").innerHTML="";

  data.forEach(app=>{

    const doctorName =
      app.doctorName ||
      app.doctor?.name ||
      app.doctorId?.name ||
      "ไม่พบชื่อแพทย์";

    const department =
      app.department ||
      app.doctor?.department ||
      app.doctorId?.department ||
      "ไม่ระบุแผนก";

    const appointmentDate = new Date(app.date);
    appointmentDate.setHours(0,0,0,0);

    const isUpcoming = appointmentDate >= today;

    let statusBadge = "";

    if(!isUpcoming){

      if(app.status === "completed"){
        statusBadge = `<div class="badge completed">มาตามนัด</div>`;
      }

      if(app.status === "no-show"){
        statusBadge = `<div class="badge no-show">ไม่มาตามนัด</div>`;
      }

      if(app.status === "cancelled"){
        statusBadge = `<div class="badge cancelled">ยกเลิก</div>`;
      }
    }

    const card = `
      <div class="app-card">

        ${statusBadge}

        <h3>${doctorName}</h3>
        <p><strong>วันที่:</strong> ${app.date}</p>
        <p><strong>เวลา:</strong> ${app.time}</p>
        <p><strong>แผนก:</strong> ${department}</p>

        ${
          isUpcoming && app.status === "booked"
          ? `<button class="cancel-btn"
               onclick="cancelAppointment('${app._id}')">
               ยกเลิก
             </button>`
          : ""
        }

      </div>
    `;

    if(isUpcoming)
      document.getElementById("upcoming").innerHTML+=card;
    else
      document.getElementById("past").innerHTML+=card;
  });
}

async function cancelAppointment(id){
  if(!confirm("ยืนยันการยกเลิกนัด?")) return;

  await fetch(`https://medica-plus.onrender.com/api/appointments/${id}/cancel`,{
    method:"PUT"
  });

  loadAppointments();
}

loadAppointments();
</script>

</body>
</html>